<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidarr Downloader</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéµ</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --surface: #f3f4f6;
            --border: #e5e7eb;
            --text: #111827;
            --text-dim: #6b7280;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header */
        header {
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--card-shadow);
        }

        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-icon { font-size: 2rem; }
        .logo-text {
            font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* Controls */
        .controls { display: flex; gap: 15px; align-items: center; }
        
        .search-box { position: relative; }
        .search-input {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 10px 15px 10px 35px; border-radius: 8px; width: 250px;
            font-size: 0.9rem; outline: none;
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        .theme-toggle {
            background: none; border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;
            transition: 0.2s;
        }
        .theme-toggle:hover { background: var(--border); }

        /* Main Content */
        main {
            flex: 1; max-width: 1200px; margin: 30px auto; padding: 0 20px; width: 100%; box-sizing: border-box;
        }

        /* Artist Group Card */
        .artist-group {
            margin-bottom: 30px; background: var(--surface); border-radius: 12px;
            border: 1px solid var(--border); overflow: hidden; box-shadow: var(--card-shadow);
        }

        .artist-header {
            background: rgba(0,0,0,0.05); padding: 12px 20px; border-bottom: 1px solid var(--border);
            font-weight: 700; font-size: 1.1rem; color: var(--accent); display: flex; align-items: center; gap: 10px;
        }

        table { width: 100%; border-collapse: collapse; }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: rgba(255,255,255,0.03); }

        .album-title { font-weight: 600; font-size: 1rem; }
        .album-year {
            color: var(--text-dim); font-size: 0.85rem; font-family: monospace;
            background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border);
        }

        /* Buttons & Status */
        .btn-download {
            background-color: var(--accent); color: white; border: none; padding: 8px 16px;
            border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem;
            transition: transform 0.1s, background 0.2s;
        }
        .btn-download:hover { background-color: var(--accent-hover); transform: scale(1.02); }
        
        .status-box { display: none; width: 100%; max-width: 180px; }
        .status-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .status-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }
        .status-text { font-size: 0.75rem; color: var(--text-dim); margin-top: 2px;}

        .status-done { color: var(--success); font-weight: 600; display: none; font-size: 0.9rem;}
        .status-err { color: var(--error); font-weight: 600; display: none; font-size: 0.9rem;}

        footer {
            text-align: center; padding: 20px; color: var(--text-dim); font-size: 0.85rem;
            border-top: 1px solid var(--border); margin-top: auto;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <div class="logo-icon">üéµ</div>
            <div class="logo-text">Lidarr Downloader</div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Filter artist or album..." onkeyup="filterList()">
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Switch Theme">‚óë</button>
        </div>
    </header>

    <main>
        {% if albums|length == 0 %}
        <div style="text-align: center; padding: 50px; color: var(--text-dim);">
            <h2>üéâ All caught up!</h2>
            <p>No missing albums found in Lidarr.</p>
        </div>
        {% endif %}

        {% for artist, items in albums|groupby('artist') %}
        <div class="artist-group" data-artist="{{ artist|lower }}">
            <div class="artist-header">
                üë§ {{ artist }}
            </div>
            <table>
                <tbody>
                    {% for album in items %}
                    <tr class="album-row" data-search="{{ artist|lower }} {{ album.title|lower }}">
                        <td style="width: 60%;">
                            <div class="album-title">{{ album.title }}</div>
                        </td>
                        <td style="width: 10%;">
                            <span class="album-year">{{ album.year }}</span>
                        </td>
                        <td style="width: 30%; text-align: right;">
                            
                            <button class="btn-download" id="btn-{{ album.id }}" 
                                    onclick="startDownload({{ album.id }}, '{{ album.title|replace("'", "\\'") }}', '{{ album.artist|replace("'", "\\'") }}', {{ album.artistId }}, '{{ album.mbId }}')">
                                ‚¨á Download
                            </button>

                            <div class="status-box" id="status-{{ album.id }}">
                                <div class="status-text" id="txt-{{ album.id }}">Starting...</div>
                                <div class="status-bar"><div class="status-fill" id="fill-{{ album.id }}"></div></div>
                            </div>

                            <div class="status-done" id="done-{{ album.id }}">‚úî Imported</div>
                            <div class="status-err" id="err-{{ album.id }}">‚ö† Error</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </main>

    <footer>
        Made with love ‚ù§Ô∏è for the community
    </footer>

    <script>
        // Theme Manager
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        initTheme();

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        // Search Filter
        function filterList() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const groups = document.querySelectorAll('.artist-group');

            groups.forEach(group => {
                const rows = group.querySelectorAll('.album-row');
                let visibleRows = 0;

                rows.forEach(row => {
                    const text = row.getAttribute('data-search');
                    if (text.includes(input)) {
                        row.classList.remove('hidden');
                        visibleRows++;
                    } else {
                        row.classList.add('hidden');
                    }
                });

                if (visibleRows === 0) {
                    group.classList.add('hidden');
                } else {
                    group.classList.remove('hidden');
                }
            });
        }

        // Download Logic
        function startDownload(id, title, artist, artistId, mbId) {
            const btn = document.getElementById(`btn-${id}`);
            const statusBox = document.getElementById(`status-${id}`);
            
            btn.style.display = 'none';
            statusBox.style.display = 'block';

            fetch('/start_download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: id, 
                    title: title, 
                    artist: artist, 
                    artistId: artistId,
                    mbId: mbId 
                })
            })
            .then(res => res.json())
            .then(data => {
                trackProgress(id);
            });
        }

        function trackProgress(id) {
            const interval = setInterval(() => {
                fetch(`/status/${id}`)
                .then(res => res.json())
                .then(data => {
                    const fill = document.getElementById(`fill-${id}`);
                    const txt = document.getElementById(`txt-${id}`);

                    fill.style.width = data.percent + '%';
                    txt.innerText = `${data.percent}% (${data.current}/${data.total})`;

                    if (data.state === 'completed') {
                        clearInterval(interval);
                        document.getElementById(`status-${id}`).style.display = 'none';
                        document.getElementById(`done-${id}`).style.display = 'block';
                    }
                    if (data.state === 'error') {
                        clearInterval(interval);
                        document.getElementById(`status-${id}`).style.display = 'none';
                        document.getElementById(`err-${id}`).style.display = 'block';
                    }
                });
            }, 1000);
        }
    </script>

</body>
</html>
